/*!
 * downstream-electron,0.1.0,2017-12-06 19:19:20.097,castlabs GmbH
 * 
 * Copyright (C) 2017 Castlabs GmbH.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("fs"),require("path"),require("underscore"),require("mkdirp"),require("request"),require("xmldom"),require("events"),require("jsonfile"),require("express"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("url-parse"),require("domain"),require("util"),require("net"),require("cors"));else if("function"==typeof define&&define.amd)define(["fs","path","underscore","mkdirp","request","xmldom","events","jsonfile","express","flake-idgen","biguint-format","moment/moment","url-parse","domain","util","net","cors"],e);else{var n="object"==typeof exports?e(require("fs"),require("path"),require("underscore"),require("mkdirp"),require("request"),require("xmldom"),require("events"),require("jsonfile"),require("express"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("url-parse"),require("domain"),require("util"),require("net"),require("cors")):e(t.fs,t.path,t.underscore,t.mkdirp,t.request,t.xmldom,t.events,t.jsonfile,t.express,t["flake-idgen"],t["biguint-format"],t["moment/moment"],t["url-parse"],t.domain,t.util,t.net,t.cors);for(var o in n)("object"==typeof exports?exports:t)[o]=n[o]}}(this,function(t,e,n,o,r,i,s,a,u,l,d,f,c,h,p,m,g){return function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="build/",e(e.s=29)}([function(t,e,n){"use strict";function o(t){t=t||{};var e=t.code;return e||(e=p.GENERAL),e}function r(t,e){var n=t,o=[];if("object"===(void 0===n?"undefined":f(n))&&(n=n.msg),n)if(e instanceof Array)for(var r=a(n.match(m)),i=0,s=Math.min(r.length,e.length);i<s;i++){var u={};u[r[i].replace(/%/g,"")]=e[i],o.push(u)}else if("object"===(void 0===e?"undefined":f(e))){for(var l in e)if(e.hasOwnProperty(l)){var d={};d[l]=e[l],o.push(d)}}else if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)for(var c=n.match(m)||[],h=0,p=c.length;h<p;h++){var g={};g[c[h].replace(/%/g,"")]=e,o.push(g)}return o&&!o.length&&(o=void 0),o}function i(t,e){var n=t;return"object"===(void 0===n?"undefined":f(n))&&(n=n.msg),n=n?u(n,e):"Internal Error"}function s(t){for(var e=[],n=1,o=t.length;n<o;n++)e.push(t[n]);return 0===e.length?e=void 0:1===e.length&&(e=e[0]),e}function a(t){var e={},n=[];t=t||[];for(var o=0,r=t.length;o<r;o++)e[t[o]]||(e[t[o]]=!0,n.push(t[o]));return n}function u(t,e){if((e=e||{})instanceof Array)for(var n=a(t.match(m)),o=0,r=Math.min(n.length,e.length);o<r;o++)t=t.replace(new RegExp(n[o],"g"),e[o]);else if("object"===(void 0===e?"undefined":f(e))){for(var i in e)e.hasOwnProperty(i)&&(t=t.replace(new RegExp("%"+i+"%","g"),e[i]));t=t.replace(m,e)}else"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e||(t=t.replace(m,e));return t}function l(t){var e=s(arguments),n=r(t,e),a=i(t,e);return{code:o(t),msg:a,keys:n}}function d(t){return i(t,s(arguments))}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=n(49),h=n(50),p=n(13),m=/%[A-Za-z0-9_-]+%/g,g={};g.getError=l,g.getTranslation=d,g.e=c,g.t=h,t.exports=g},function(t,e,n){"use strict";function o(t){var e=i.getPath("userData"),n="settings",o="public",r="movies";t&&(t.appDir&&(e=t.appDir),t.settingsName&&(n=t.settingsName),t.publicName&&(o=t.publicName),t.downloadsName&&(r=t.downloadsName),t.offlineDomain&&(a.offlineDomain=t.offlineDomain),t.offlineContentPortStart&&(a.offlineContentPortStart=t.offlineContentPortStart),t.maxOfflineContentPortRange&&(a.maxOfflineContentPortRange=t.maxOfflineContentPortRange),t.numberOfManifestsInParallel&&(a.numberOfManifestsInParallel=t.numberOfManifestsInParallel)),e=s.join(s.resolve(e),"/");var u=s.join(s.resolve(e+n)+"/","/"),l=s.join(s.resolve(e+o)+"/","/"),d=s.join(s.resolve(l+r)+"/","/");a.appDir=e,a.downloadsFolderPath=d,a.downloadsName=r,a.publicFolderPath=l,a.settingsFolder=u}function r(){return a}var i=n(4).app,s=n(3),a={downloadingThreadsRules:{items:[{max:10,files:5},{max:100,files:10},{max:1e3,files:30},{max:1e5,files:50}],threads:[{size:10,number:1},{size:100,number:3},{size:1e3,number:4},{size:1e5,number:5}]},MAX_ERRORS_DOWNLOAD_RETRY:5,MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY:100,MAX_ERRORS_DOWNLOAD_CHUNK_RETRY:5,offlineDomain:"http://127.0.0.1",offlineContentPortStart:3010,maxOfflineContentPortRange:3030,numberOfManifestsInParallel:2,stores:{DOWNLOADS:{LEFT:"left",DOWNLOADING:"downloading",DOWNLOADED:"downloaded",ERRORS:"errors"},STATUS:"status",PARAMS:"params",MANIFEST:"manifest",PERSISTENT:"persistent",DATA:"data"},saveToDisk:!0,times:{DOWNLOAD_TIMEOUT:5e3,RETRY_TIMEOUT:5e3},defaultManifestRequestOptions:{headers:{Accept:"*/*","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36"},timeout:5e3}};e.load=o,e.getSettings=r},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("path")},function(t,e,n){(function(e){var o=n(2),r=n(3),i=r.join(e,"path.txt");if(!o.existsSync(i))throw new Error("Electron failed to install correctly, please delete node_modules/electron and try installing again");t.exports=r.join(e,o.readFileSync(i,"utf-8"))}).call(e,"/")},function(t,e){t.exports=n},function(t,e,n){"use strict";var o={CREATED:"CREATED",STARTED:"STARTED",ERROR:"ERROR",STOPPED:"STOPPED",FINISHED:"FINISHED",BROKEN:"BROKEN"};t.exports=o},function(t,e,n){"use strict";var o=n(32),r=n(33),i=new o,s=function(){function t(){}return t.getUUID=function(){var t=i.next();return r(t,"dec")},t}();e.SnowflakeId=s},function(t,e,n){"use strict";t.exports=function(t,e,n){if(void 0!==n)for(var o=0,r=e.length;o<r;o++){var i=e[o],s=i.defaultValue,a=i.name||i;t[a]=void 0!==n[a]?n[a]:s}}},function(t,e){t.exports=o},function(t,e,n){"use strict";var o=n(36),r=n(37),i=n(17),s=n(45),a=n(7),u=n(46),l=n(47),d=new o.ManifestLoader,f=n(48),c=function(){function t(t){this.id=t||String(a.SnowflakeId.getUUID())}return t.prototype.load=function(t){var e=this;return new Promise(function(n,o){var r=f(t).pathname;e.url=t,e.url_domain=t.substring(0,t.lastIndexOf("/")+1),e.manifest_name=r.substring(r.lastIndexOf("/")+1,r.length),d.load(t).then(function(t){var r=t.response;e.manifestXML=new i.ManifestXML(r,function(){n()},function(t){throw o(t),new Error("Manifest parsing error")})},function(t){o(t)})})},t.prototype.loadFromLocal=function(t,e){var n=this;return new Promise(function(o,s){r(t).then(function(t){n.url_domain=e.substring(0,e.lastIndexOf("/")+1),n.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length),n.manifestXML=new i.ManifestXML(t,function(){o()},function(t){s(t)})},function(t){s(t)})})},t.prototype.loadFromStr=function(t,e){this.url_domain=e.substring(0,e.lastIndexOf("/")+1),this.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length),this.manifestXML=new i.ManifestXML(t)},t.prototype.getAdaptationSets=function(){var t=this.manifestXML.getVideoAdaptation(),e=this.manifestXML.getAudioAdaptation(),n=this.manifestXML.getTextAdaptation();return new s.AllAdaptationSets(t,e,n)},t.prototype.getVideoRepresentations=function(){return this.manifestXML.getVideoAdaptation()},t.prototype.getAudioRepresentations=function(){return this.manifestXML.getAudioAdaptation()},t.prototype.getTextRepresentations=function(){return this.manifestXML.getTextAdaptation()},t.prototype.getProtections=function(){var t={};return t.video=l(this.getVideoRepresentations()),t.audio=l(this.getAudioRepresentations()),t.text=l(this.getTextRepresentations()),t},t.prototype.getRemoteDomain=function(){return this.url_domain},t.prototype.getManifestName=function(){return this.manifest_name},t.prototype.getManifestUrl=function(){return this.url_domain+this.manifest_name},t.prototype.getManifestXML=function(){return this.manifestXML.getManifestXML()},t.prototype.getJsonInfo=function(){var t={};return t.id=this.id,t.audio=u(this.getAudioRepresentations()),t.video=u(this.getVideoRepresentations()),t.text=u(this.getTextRepresentations()),t.protections=this.getProtections(),t},t}();e.Manifest=c},function(t,e){t.exports=r},function(t,e){t.exports=i},function(t,e,n){"use strict";var o={GENERAL:-1,ERRORS:{INTERNAL_ERROR:1,BROKEN:11,FINISHED:12,UNFINISHED:13,STOPPED:14,CREATED:15,MISSING:16,RESUMED:17,STARTED:18,LOADING:19,REMOVED:20,INFO:21,NOT_FOUND:100}};t.exports=o},function(t,e,n){"use strict";function o(t,e,n){this.manifestId=t,this.storageKey=e,this.items=n}var r=n(9),i=n(1),s=n(23),a=n(62);o.prototype._saveToDisk=function(t,e){var n=this,o=i.getSettings().settingsFolder+this.manifestId+"/",a=this.storageKey+".json",l=o+a;r(o,function(o){if(o)e(o);else{var r=u(n.storageKey,n.items);s.writeFile(l,r,function(n){n?e(n):t()})}})},o.prototype.save=function(){return new Promise(this._saveToDisk.bind(this))},t.exports=o;var u=function(t,e){var n=[],o=void 0;if("downloading"===t){n=[];for(var r in e)n.push(e[r]);e=n}if(e instanceof Array){o=[];for(var i=0,s=e.length;i<s;i++)o.push(new a(e[i]))}else o=e;return o}},function(t,e){t.exports=require("events")},function(t,e,n){"use strict";t.exports={regexpProtocolRemove:/^https{0,1}\:\/\//i}},function(t,e,n){"use strict";var o=n(38),r=n(12).DOMParser,i=function(){function t(t,e,n){var i=void 0;i="function"==typeof e&&"function"==typeof n?new r({errorHandler:{warning:function(){},error:n,fatalError:n}}):new r,this.adaptationSetColl=[],this.xml=i.parseFromString(t,"application/xml");for(var s=this.xml.getElementsByTagName("AdaptationSet"),a=0;a<s.length;a++){var u=new o.AdaptationSetNode(s[a],this.xml);this.adaptationSetColl[a]=u}"function"==typeof e&&e()}return t.prototype.getVideoAdaptation=function(){return this.getAdaptations("video")},t.prototype.getAudioAdaptation=function(){return this.getAdaptations("audio")},t.prototype.getTextAdaptation=function(){return this.getAdaptations("text")},t.prototype.getManifestXML=function(){return this.xml},t.prototype.getAdaptations=function(t){return this.adaptationSetColl.map(function(t){return t}).filter(function(e){if(e.isMimeType(t))return!0})},t.cloneXML=function(t){var e=t.implementation.createDocument(t.namespaceURI,null,null),n=e.importNode(t.documentElement,!0);return e.appendChild(n),e},t.removeNode=function(t){for(var e=t.documentElement.getElementsByTagName("Representation"),n=t.documentElement.getElementsByTagName("AdaptationSet"),o=[],r=[],i=0;i<e.length;i++)o[i]=e[i];o.forEach(function(t){!(!t.attributes.getNamedItem("markForDownload")||"true"!=t.attributes.getNamedItem("markForDownload").value)||t.parentNode.removeChild(t),t.removeAttribute("markForDownload")},this);for(var s=0;s<n.length;s++)r[s]=n[s];return r.forEach(function(t){t.getElementsByTagName("Representation").length||t.parentNode.removeChild(t)}),t},t}();e.ManifestXML=i},function(t,e,n){"use strict";var o=n(7),r=function(){function t(t,e){this.childCollection=[],this.attributeList={},this.setCurrentNode(t),this.setChildCollection(t.childNodes),this.buildAttributeList(t,this.attributeList),this.setParentNode(t.parentNode),this.xml=e,this.id=o.SnowflakeId.getUUID()}return t.prototype.setParentNode=function(t){this.parentNode=t},t.prototype.setChildCollection=function(t){this.childCollection=t},t.prototype.setCurrentNode=function(t){this.currentNode=t},t.prototype.buildAttributeList=function(t,e){this.writeAttributesToList(t,e)},t.prototype.writeAttributesToList=function(t,e){var n=t.attributes;for(var o in n)e[n[o].nodeName]||(e[n[o].nodeName]=n[o].nodeValue);null!==t.parentNode&&this.buildAttributeList(t.parentNode,e)},t.prototype.getCurrentNode=function(){return this.currentNode},t.prototype.markNodeForDownload=function(t){var e=this.xml.createAttribute("markForDownload");t?(e.value=t.toString(),this.currentNode.setAttributeNode(e)):this.currentNode.removeAttribute("markForDownload")},t.prototype.getAttributeList=function(){return this.attributeList},t}();e.ManifestNode=r},function(t,e,n){"use strict";var o=n(8);t.exports=function(t){o(this,["audioSamplingRate","bandwidth","id","lang"],t)}},function(t,e,n){"use strict";var o=n(8);t.exports=function(t){o(this,["bandwidth","id","height","lang","width"],t)}},function(t,e,n){"use strict";var o=n(8);t.exports=function(t){o(this,["bandwidth","id","lang"],t)}},function(t,e,n){"use strict";function o(t,e,n){function s(r){if(r&&"ENOTEMPTY"===r.code&&n<a)return n++,console.error("ERROR ENOTEMPTY",t,n),void setTimeout(function(){o(t,e,n)},u);r&&"ENOENT"===r.code&&(arguments[0]=null),f||(f=arguments),e&&!d&&(d=!0,e.apply(l,f))}n=n||0;var a=10,u=500;if("string"!=typeof t)throw new Error("directory path required");if(void 0!==e&&"function"!=typeof e)throw new Error("callback must be function");var l=this,d=void 0,f=void 0;r.exists(t,function(e){function n(e,n){if(e)return s(e);var a=n.length;if(0===a)return r.rmdir(t,s);n.forEach(function(e){o(i.resolve(t,e),function(e){return e?s(e):0==--a?r.rmdir(t,s):void 0})})}if(!e)return s(null);r.stat(t,function(e,o){return e?s(e):o.isDirectory()?void r.readdir(t,n):r.unlink(t,s)})})}var r=n(2),i=n(3);t.exports=o},function(t,e){t.exports=a},function(t,e,n){"use strict";function o(t,e){r.exists(t,function(n){n?r.stat(t,function(t,n){t?e(!1):e(!0,n.size)}):e(!1)})}var r=n(2),i=n(1),s=Object.assign({start:0,end:null},i.getSettings().defaultManifestRequestOptions),a={ABORTED:"ABORTED",CHUNK_ERROR:"CHUNK_ERROR",CHUNK_SIZE_ERROR:"CHUNK_SIZE_ERROR",FILE_CREATING_ERROR:"FILE_CREATING_ERROR",FILE_WRITING_ERROR:"FILE_WRITING_ERROR",INTERNET:"INTERNET",TIMEOUT:"TIMEOUT"};t.exports={checkForLocalFile:o,defaultOptions:s,errors:a}},function(t,e,n){"use strict";function o(){this._items=[]}o.prototype.clear=function(){this._items=[]},o.prototype.concat=function(t){this._items=this._items.concat(t)},o.prototype.count=function(){return this._items.length},o.prototype.getItems=function(){return this._items},o.prototype.push=function(t){this._items.push(t)},o.prototype.shift=function(){return this._items.shift()},o.prototype.unshift=function(){return this._items.unshift.apply(this,arguments)},t.exports=o},function(t,e,n){"use strict";function o(t,e){function n(){var t=[],e=void 0,n=void 0;for(e=0,n=arguments.length;e<n;e++)t.push(arguments[e]);return t.unshift(this._storageKey),this._parent._itemAction.apply(this._parent,t)}for(var o in e.prototype)e.prototype.hasOwnProperty(o)&&(t[o]=n.bind(t,o))}t.exports=o},function(t,e,n){"use strict";function o(){this._items={}}o.prototype.clear=function(){this._items={}},o.prototype.count=function(){return this.getKeys().length},o.prototype.decrease=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]--},o.prototype.getItem=function(t){return this._items[t]},o.prototype.getItems=function(){return this._items},o.prototype.getKeys=function(){return Object.keys(this._items)},o.prototype.increase=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]++},o.prototype.removeItem=function(t){delete this._items[t]},o.prototype.setItem=function(t,e){this._items[t]=e},o.prototype.setItems=function(t){for(var e in t)t.hasOwnProperty(e)&&this.setItem(e,t[e])},t.exports=o},function(t,e,n){"use strict";function o(){for(var t="",e=void 0,n=0,o=arguments.length;n<o;n++)e=arguments[n].replace(/^\.\//g,"/"),t+=e,n<o-1&&(t+="/");return t=t.replace(/\/{2,}/g,"/"),t=t.replace("https:/","https://"),t=t.replace("http:/","http://"),t=t.replace("file:/","file://")}function r(){return o.apply(null,arguments)+"/"}function i(){return o.apply(null,arguments)}t.exports={joinPath:r,joinPathWithFile:i}},function(t,e,n){t.exports=n(30)},function(t,e,n){"use strict";var o=n(5),r=n(31),i=n(7),s=n(1),a=n(34),u=n(71),l=n(84),d=n(86),f=n(89),c=n(92),h=void 0;h=function(){this._offlineContentPort=s.getSettings().offlineContentPortStart,o.bindAll(this,"_onApiRequest","processSubscriber"),this._createControllers(),this._serveOfflineContent(),this._attachEvents()},h.prototype._apiMethods=function(t,e,n,r){var s=this,a=n[0],u={};u.promiseId=e;var l=function(t,e){u.subscribersId=e,u.status="OK",u.result=t,u.manifestId=a,s._send(u,r)},d=function(e,l){var d=String(i.SnowflakeId.getUUID()),f=o.clone({errorId:d,methodName:t,args:n.slice(4),err:e,internalError:l});u.manifestId=a,u.status="ERROR",u.error=e||{},u.error.errorId=d,s._send(u,r);try{console.error(new Date,"Error occurred",JSON.stringify(f))}catch(t){}};n=n||[],n.unshift(r),n.unshift(d),n.unshift(l),n.unshift(this);var f=this._getMethod(t);"function"==typeof f?f.apply(null,n):(u.status="ERROR",u.error="Provided method '"+t+"' doesn't exists",this._send(u,r),console.error("ERROR","Provided method '"+t+"' doesn't exists"))},h.prototype._attachEvents=function(){n(4).ipcMain.on("downstreamElectronBE",this._onApiRequest)},h.prototype._createControllers=function(){this.manifestController=new d,this.offlineController=new f(this.manifestController),this.downloadsController=new u(this.manifestController,this.offlineController),this.subscribersController=new c},h.prototype._getMethod=function(t){var e=t.split("."),n=void 0,o=void 0,r=void 0;for(r=a[e[0]],n=1,o=e.length;n<o;n++)r=r[e[n]];return r},h.prototype._onApiRequest=function(t,e,n){var o=e.promiseId,r=e.args,i=e.method;n=e.windowId;for(var s=[],a=0;r[a];)s.push(r[a]),a++;this._apiMethods(i,o,s,n)},h.prototype._send=function(t,e){try{for(var o=n(4).BrowserWindow.getAllWindows(),r=0,i=o.length;r<i;r++)if(o[r].id===e){o[r].webContents.send("downstreamElectronFE",t);break}}catch(t){console.error("internal error ocurred",t)}},h.prototype._serveOfflineContent=function(){function t(n){n>a||l(n,function(o){o?(n++,t(n)):i.listen(n,function(){e._offlineContentPort=n,console.info("Offline content served on port "+n)})})}var e=this,o=n(93),i=r(),a=s.getSettings().maxOfflineContentPortRange,u=s.getSettings().publicFolderPath;i.use(o()),i.use(r.static(u)),t(this._offlineContentPort)},h.prototype.getOfflinePath=function(t){var e=s.getSettings().offlineDomain,n=this._offlineContentPort;return n&&(e+=":"+n),e+="/"+s.getSettings().downloadsName+"/"+t+"/"},h.prototype.processSubscriber=function(t,e,n,o,r){var i={};i.subscriberId=t,i.status=e?"ERROR":"OK",i.err=e,i.result=n,i.subscriberFinished=r,this._send(i,o),r&&this.subscribersController.removeAllManifestSubscribersById(t)},t.exports={init:function(t){return s.load(t),new h}}},function(t,e){t.exports=u},function(t,e){t.exports=l},function(t,e){t.exports=d},function(t,e,n){"use strict";var o={};o.create=n(35),o.createPersistent=n(51),o.getList=n(52),o.getListWithInfo=n(53),o.getOfflineLink=n(54),o.info=n(55),o.remove=n(56),o.removeAll=n(57),o.removeAllUnfinished=n(58),o.removePersistent=n(59),o.resume=n(60),o.saveData=n(61),o.savePersistent=n(63),o.start=n(64),o.stop=n(65),o.stopAll=n(66),o.subscribe=n(67),o.unsubscribe=n(69);var r=n(70);t.exports={downloads:o,removeSubscribers:r}},function(t,e,n){"use strict";var o=n(10).Manifest,r=n(0);t.exports=function(t,e,n,i,s){var a=new o;a.load(s).then(function(){t.manifestController.cacheManifest(a),e(a.getJsonInfo())},function(t){n(r.getError(r.e.manifests.LOADING_FAILED,s),t)})}},function(t,e,n){"use strict";var o=n(11),r=n(1),i=function(){function t(){}return t.prototype.load=function(t){return this.sendXMLHttpRequest(t)},t.prototype.sendXMLHttpRequest=function(t){var e=Object.assign({},r.getSettings().defaultManifestRequestOptions);return new Promise(function(n,r){o.get(t,e,function(e,o){!e&&o.statusCode>=400&&(e=o.statusMessage),e?r(new Error("MANIFEST LOAD FAILURE "+e)):n({response:o.body,url:t})})})},t}();e.ManifestLoader=i},function(t,e,n){"use strict";function o(t){return new Promise(function(e,n){r.readFile(i.resolve(t),"utf-8",function(t,o){t?n(t):e(o)})})}var r=n(2),i=n(3);t.exports=o},function(t,e,n){"use strict";var o=function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},r=n(18),i=n(39),s=function(t){function e(e,n){t.call(this,e,n),this.representationColl=[],this.contentProtections=[];for(var o=e.getElementsByTagName("Representation"),r=0;r<o.length;r++){var s=new i.RepresentationNode(o[r],this.xml);this.representationColl[r]=s,this.representationColl[0].hasMimeType()&&(this.attributeList.mimeType=this.representationColl[0].getMimeType())}for(var a=e.getElementsByTagName("ContentProtection"),u=0;u<a.length;u++){var l=a[u].attributes,d=a[u].getElementsByTagName("cenc:pssh");if(l.getNamedItem("schemeIdUri")&&d.length){var f={schemeIdUri:l.getNamedItem("schemeIdUri").value,cencPSSH:d[0].childNodes[0].data};this.contentProtections.push(f)}}}return o(e,t),e.prototype.getContentProtections=function(){return this.contentProtections},e.prototype.getWidevineProtection=function(){return this.contentProtections.filter(function(t){return"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===t.schemeIdUri})},e.prototype.isMimeType=function(t){return-1!=this.attributeList.mimeType.indexOf(t)},e.prototype.getRepresentations=function(){return this.representationColl.map(function(t){return t}).sort(function(t,e){return t.bandwidth>=e.bandwidth?-1:1})},e.prototype.getVideoRepresentations=function(){return this.representationColl.map(function(t){return t}).filter(function(){return!!this.isMimeType("video")}).sort(function(t,e){return t.bandwidth>=e.bandwidth?-1:1})},e.prototype.getAudioRepresentations=function(){return this.representationColl.map(function(t){return t}).sort(function(t,e){return t.bandwidth>=e.bandwidth?-1:1})},e.prototype.getTextRepresentations=function(){return this.representationColl.map(function(t){return t}).sort(function(t,e){return t.bandwidth>=e.bandwidth?-1:1})},e}(r.ManifestNode);e.AdaptationSetNode=s},function(t,e,n){"use strict";var o=function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},r=n(18),i=n(40),s=n(43),a=function(t){function e(e,n){t.call(this,e,n),this.markNodeForDownload(!1)}return o(e,t),e.prototype.createSegmentInformation=function(){var t=s.IsoDurationParser.getDuration(this.attributeList.mediaPresentationDuration),e=void 0,n=void 0,o=void 0,r=this.attributeList.id;if(this.segmentTemplate&&this.segmentTemplate.hasChildNodes())for(var a=0;a<this.segmentTemplate.childNodes.length;a++)"SegmentTimeline"==this.segmentTemplate.childNodes[a].nodeName&&(e=this.segmentTemplate.childNodes[a]);try{n=e.getElementsByTagName("S")}catch(t){}try{o=this.segmentList.getElementsByTagName("SegmentURL")}catch(t){}this.bandwidth=this.attributeList.bandwidth?parseInt(this.attributeList.bandwidth):-1,this.segmentInformation=new i.SegmentInformation(t,this.bandwidth,this.baseURL,r,this.attributeList.mimeType,this.segmentBase,this.segmentTemplate,e,n,this.segmentList,o)},e.prototype.writeAttributesToList=function(e,n){for(var o=e.attributes,r=0;r<e.childNodes.length;r++)this.baseURL||"BaseURL"!=e.childNodes[r].nodeName||(this.baseURL=e.childNodes[r].firstChild.nodeValue),this.segmentBase||"SegmentBase"!=e.childNodes[r].nodeName||(this.segmentBase=e.childNodes[r]),this.segmentTemplate||"SegmentTemplate"!=e.childNodes[r].nodeName||(this.segmentTemplate=e.childNodes[r]),this.segmentList||"SegmentList"!=e.childNodes[r].nodeName||(this.segmentList=e.childNodes[r]);for(var i in o)n[o[i].nodeName]||(n[o[i].nodeName]=o[i].nodeValue);null!==e.parentNode?this.buildAttributeList(e.parentNode,n):this.segmentInformation||this.createSegmentInformation(),t.prototype.writeAttributesToList.call(this,e,n)},e.prototype.getMimeType=function(){return this.attributeList.mimeType},e.prototype.hasMimeType=function(){return!!this.attributeList.mimeType},e.prototype.getMediaUrlList=function(){return this.segmentInformation.getMediaUrlList()},e.prototype.getRepresentationId=function(){return this.id},e}(r.ManifestNode);e.RepresentationNode=a},function(t,e,n){"use strict";var o=n(41),r=n(42),i=void 0;!function(t){t[t.FROM_TEMPLATE=0]="FROM_TEMPLATE",t[t.FROM_TIMELINE=1]="FROM_TIMELINE",t[t.FROM_SEGMENTLIST=2]="FROM_SEGMENTLIST",t[t.FROM_SEGMENT_BASE=3]="FROM_SEGMENT_BASE"}(i||(i={}));var s=function(){function t(e,n,o,s,a,u,l,d,f,c,h){this.hasSegmentBase=!1,this.baseUrl="",this.presentationDuration=0,this.bandwidth=0,this.startNumber=0,this.mediaUrls=[],this.whichUseCase=-1,this.mimeType="",t.count+=1,this.presentationDuration=e,this.mimeType=a,o&&(this.baseUrl=o),n&&(this.bandwidth=n),s&&(this.representationID=s),u&&(this.segmentBase=u,this.hasSegmentBase=!0,this.whichUseCase=i.FROM_SEGMENT_BASE),l&&(this.segmentTemplate=l,this.mediaTemplate=this.segmentTemplate.attributes.getNamedItem("media").nodeValue,this.mediaTemplate=this.replace$RepresentationID$(this.mediaTemplate,this.representationID),this.mediaTemplate=this.replace$Bandwidth$(this.mediaTemplate,this.bandwidth),this.startNumber=this.segmentTemplate.attributes.getNamedItem("startNumber")?parseInt(this.segmentTemplate.attributes.getNamedItem("startNumber").nodeValue):0,this.whichUseCase=i.FROM_TEMPLATE),d&&(this.segmentTimeline=d),f&&(this.timelineItemList=f,this.whichUseCase=i.FROM_TIMELINE),c&&(this.segmentList=c),h&&(this.segmentUrlList=h,this.whichUseCase=i.FROM_SEGMENTLIST);var p=!1,m="";switch(this.whichUseCase){case i.FROM_SEGMENTLIST:this.createFragmentFromUrlList(this.segmentUrlList),m=this.createInitSegment(this.segmentList.getElementsByTagName("Initialization")[0].attributes.getNamedItem("sourceURL").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType)),t.count;break;case i.FROM_SEGMENT_BASE:try{p=-1!==this.baseUrl.indexOf(".")}catch(t){}p&&this.mediaUrls.push(new r.MediaUrl(this.baseUrl,this.baseUrl,this.mimeType)),t.count;break;case i.FROM_TEMPLATE:this.createFragmentsFromTemplate(),m=this.createInitSegment(this.segmentTemplate.attributes.getNamedItem("initialization").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType));break;case i.FROM_TIMELINE:this.createFragmentUrlsFromTimeline(this.timelineItemList),m=this.createInitSegment(this.segmentTemplate.attributes.getNamedItem("initialization").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType));break;default:try{p=-1!==this.baseUrl.indexOf(".")}catch(t){}p&&this.mediaUrls.push(new r.MediaUrl("",this.baseUrl,this.mimeType))}}return t.prototype.createFragmentUrlsFromTimeline=function(t){var e=this.segmentTemplate.attributes.getNamedItem("presentationTimeOffset");e=e?parseInt(e.nodeValue,10):0;for(var n=!1,o=0,i=0;i<t.length;i++){i>0&&t[i].attributes.getNamedItem("t")&&void 0!==t[i].attributes.getNamedItem("t").nodeValue?(n=!0,o=parseInt(t[i].attributes.getNamedItem("t").nodeValue)):n=!1;for(var s=t[i].attributes.getNamedItem("d")&&void 0!==t[i].attributes.getNamedItem("d").nodeValue?parseInt(t[i].attributes.getNamedItem("d").nodeValue):0,a=t[i].attributes.getNamedItem("r")&&void 0!==t[i].attributes.getNamedItem("r").nodeValue?parseInt(t[i].attributes.getNamedItem("r").nodeValue):0,u=1;u<=a;u++){var l=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;l=this.replace$RepresentationID$(l,this.representationID),l=this.replace$Time$(l,e),l=this.replace$Bandwidth$(l,this.bandwidth),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,l,this.mimeType)),n?e=o:e+=s}var d=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;d=this.replace$RepresentationID$(d,this.representationID),d=this.replace$Time$(d,e),d=this.replace$Bandwidth$(d,this.bandwidth),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,d,this.mimeType)),n?e=o:e+=s}},t.prototype.createFragmentFromUrlList=function(t){for(var e=0;e<t.length;e++){var n=t[e].attributes.getNamedItem("media").nodeValue;this.mediaUrls.push(new r.MediaUrl(this.baseUrl,n,this.mimeType))}},t.prototype.createFragmentsFromTemplate=function(){for(var t=parseInt(this.segmentTemplate.attributes.getNamedItem("duration").nodeValue),e=this.segmentTemplate.attributes.getNamedItem("timescale")?parseInt(this.segmentTemplate.attributes.getNamedItem("timescale").nodeValue):1,n=Math.ceil(this.presentationDuration/(t/e)/1e3),i=this.mediaTemplate.split("$"),s=void 0,a=this.startNumber||0,u=0;u<i.length;u++)-1!=i[u].indexOf("Number")&&(s="$"+i[u]+"$");for(var l=o.ZeroPadding.getPaddingAmount(s),d=a;d<n+a;d++){var f=o.ZeroPadding.addPadding(d,l),c=void 0;c=0===l?this.replace$Number$(this.mediaTemplate,d):this.mediaTemplate.replace(s,f),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,c,this.mimeType))}},t.prototype.replace$RepresentationID$=function(t,e){return t.replace(new RegExp("\\$RepresentationID\\$","g"),e)},t.prototype.replace$Number$=function(t,e){return t.replace(new RegExp("\\$Number\\$","g"),e.toString())},t.prototype.replace$Bandwidth$=function(t,e){return t.replace(new RegExp("\\$Bandwidth\\$","g"),e.toString())},t.prototype.replace$Time$=function(t,e){return t.replace(new RegExp("\\$Time\\$","g"),e.toString())},t.prototype.createInitSegment=function(t){return t=this.replace$Bandwidth$(t,this.bandwidth),t=this.replace$RepresentationID$(t,this.representationID)},t.prototype.getMediaUrlList=function(){return this.mediaUrls},t.count=-1,t}();e.SegmentInformation=s},function(t,e,n){"use strict";var o=function(){function t(){}return t.addPadding=function(t,e){for(var n=t.toString().split("");n.length<e;)n.unshift("0");return n.join("")},t.getPaddingAmount=function(t){var e=t.indexOf("%"),n=t.lastIndexOf("$"),o=parseInt(t.substring(e+1,n-1));return o=isNaN(o)?0:o},t}();e.ZeroPadding=o},function(t,e,n){"use strict";var o=function(){function t(t,e,n,o){void 0===o&&(o=""),this.baseURL=t,this.mediaFile=-1!==e.indexOf("/")?this.truncateMediaFilePath(e):e,this.url_domain=o,this.mimeType=n}return t.prototype.truncateMediaFilePath=function(t){var e=t.lastIndexOf("/"),n=t.substring(0,e),o=t.substring(e+1,t.length);return this.baseURL+=n,o},t.prototype.getFileAddress=function(){return this.baseURL+this.mediaFile},t}();e.MediaUrl=o},function(t,e,n){"use strict";var o=n(44),r=function(){function t(){}return t.getDuration=function(t){return o.duration(t).asMilliseconds()},t.getMoment=function(){return o},t}();e.IsoDurationParser=r},function(t,e){t.exports=f},function(t,e,n){"use strict";var o=function(){function t(t,e,n){this.videoAdaptation=t,e&&(this.audioAdaptation=e),n&&(this.textAdaptation=n)}return t}();e.AllAdaptationSets=o},function(t,e,n){"use strict";var o=n(19),r=n(20),i=n(21);t.exports=function(t){for(var e=[],n=0,s=t.length;n<s;n++)for(var a=t[n].representationColl,u=0,l=a.length;u<l;u++){var d=a[u].attributeList,f=d.contentType||d.mimeType;switch(f=f.indexOf("video")>=0?"video":f.indexOf("audio")>=0?"audio":"text"){case"audio":e.push(new o(d));break;case"video":e.push(new r(d));break;default:e.push(new i(d))}}return e}},function(t,e,n){"use strict";var o=n(19),r=n(20),i=n(21);t.exports=function(t){for(var e=[],n=0,s=t.length;n<s;n++)for(var a=t[n].representationColl,u=0,l=a.length;u<l;u++){var d=a[u].attributeList,f=d.contentType||d.mimeType;switch(f=f.indexOf("video")>=0?"video":f.indexOf("audio")>=0?"audio":"text"){case"audio":e.push(new o(d));break;case"video":e.push(new r(d));break;default:e.push(new i(d))}e[u].protections=t[n].contentProtections.slice()}return e}},function(t,e){t.exports=c},function(t,e,n){"use strict";var o=n(13),r={downloads:{_GENERAL:{code:o.ERRORS.INTERNAL_ERROR,msg:"Sorry we are unable to process your request - some internal error occurred"},ALREADY_FINISHED:{code:o.ERRORS.FINISHED,msg:"This download '%manifestId%' has been already finished."},ALREADY_REMOVED_ALL_UNFINISHED:{code:o.ERRORS.REMOVED,msg:"All unfinished downloads have been already removed, nothing left."},ALREADY_RESUMED:{code:o.ERRORS.RESUMED,msg:"This download '%manifestId%' has been already resumed."},ALREADY_STOPPED:{code:o.ERRORS.STOPPED,msg:"This download '%manifestId%' has been already stopped."},ALREADY_STOPPED_ALL:{code:o.ERRORS.STOPPED,msg:"There are no downloads to be stopped."},ALREADY_STARTED:{code:o.ERRORS.STARTED,msg:"This download '%manifestId%' has been already started."},BROKEN_CANNOT_BE_RESUMED:{code:o.ERRORS.BROKEN,msg:"This download '%manifestId%' is broken and cannot be resumed."},INFO_FAILED:{code:o.ERRORS.INFO,msg:"Gettting info of download '%manifestId%' failed."},REMOVING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all downloads failed."},REMOVING_ALL_UNFINISHED_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all unfinished downloads failed."},REMOVING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of download '%manifestId%' failed."},RESUMING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Resuming of download '%manifestId%' failed."},STOPPING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping of download '%manifestId%' failed."},SAVING_PERSISTENT_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving persistent info for download '%manifestId%' failed."},SAVING_DATA_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving data for download '%manifestId%' failed."},STOPPING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping all downloads failed."},UNFINISHED:{code:o.ERRORS.UNFINISHED,msg:"This download is not ready yet."}},manifests:{NOT_FOUND:{code:o.ERRORS.NOT_FOUND,msg:"Manifest with id='%manifestId%' not found."},LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load manifest from url '%manifestUrl%'."},LIST_LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load list of manifests."}}};t.exports=r},function(t,e,n){"use strict";t.exports={test:"Hello world"}},function(t,e,n){"use strict";t.exports=function(t,e){e()}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n){t.offlineController.getManifestsList(function(t,r){t?n(o.getError(o.e.manifests.LIST_LOADING_FAILED),t):e(r)})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(t,r){t?n(o.getError(o.e.manifests.LIST_LOADING_FAILED),t):e(r)})}},function(t,e,n){"use strict";var o=n(6),r=n(0);t.exports=function(t,e,n,i,s){t.offlineController.getManifestInfo(s,function(i,a){i?n(r.getError(r.e.downloads._GENERAL),i):a.status===o.FINISHED?e({offlineLink:t.getOfflinePath(s)+a.manifest.name,persistent:a.persistent}):n(r.getError(r.e.downloads.UNFINISHED,s),i)})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,i){t.offlineController.getManifestInfo(i,function(t,r){t?n(o.getError(o.e.manifests.INFO_FAILED,i),t):e(r)})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,i){t.offlineController.getManifestInfo(i,function(r,s){t.downloadsController.removePromise(i).then(function(){t.offlineController.removePromise(i).then(function(){t.subscribersController.unsubscribe(i),t.manifestController.removeFromCache(i),e(s)},function(t){n(o.getError(o.e.downloads.REMOVING_FAILED,i),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_FAILED,i),t)})})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(r,i){if(r)n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),r);else{for(var s=i.map(function(t){return t.manifestInfo.id}),a=[],u=0,l=s.length;u<l;u++)a.push(t.downloadsController.removePromise(s[u]));Promise.all(a).then(function(){t.offlineController.removeAllPromise().then(function(){t.subscribersController.unsubscribeAll(),t.manifestController.removeFromCacheAll(),e(i)},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),t)})}})}},function(t,e,n){"use strict";var o=n(0),r=n(6);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(i,s){if(i)n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),i);else{var a=[],u=[];if(!s.length)return void n(o.getError(o.e.downloads.ALREADY_REMOVED_ALL_UNFINISHED));for(var l=0,d=s.length;l<d;l++){var f=s[l].status,c=s[l].manifestInfo.id;f!==r.FINISHED&&(u.push(c),a.push(t.downloadsController.removePromise(c)))}Promise.all(a).then(function(){for(var r=[],i=0,s=u.length;i<s;i++)r.push(t.offlineController.removePromise(u[i]));Promise.all(r).then(function(){t.subscribersController.unsubscribe(u),t.manifestController.removeFromCache(u),e(u)},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})}})}},function(t,e,n){"use strict";var o=n(1),r=n(0),i=n(22);t.exports=function(t,e,n,s,a){t.offlineController.getManifestInfo(a,function(t,s){if(t)n(r.getError(r.e.manifests.NOT_FOUND,a),t);else{var u=o.getSettings().settingsFolder+a+"/"+o.getSettings().stores.PERSISTENT+".json";i(u,function(t){t&&"ENOENT"!==t.code?n(r.getError(r.e.downloads.REMOVING_PERSISTENT_FAILED,a),t):e(s)})}})}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r,i){t.downloadsController.start(r,i,e,n,!0)}},function(t,e,n){"use strict";var o=n(1),r=n(0),i=n(14);t.exports=function(t,e,n,s,a,u){t.offlineController.getManifestInfo(a,function(t){if(t)n(r.getError(r.e.manifests.NOT_FOUND,a),t);else{new i(a,o.getSettings().stores.DATA,u).save().then(function(){e()},function(t){n(r.getError(r.e.downloads.SAVING_DATA_FAILED,a),t)})}})}},function(t,e,n){"use strict";var o=n(8);t.exports=function(t){o(this,["id","contentType","remoteUrl","stats","localUrl"],t)}},function(t,e,n){"use strict";var o=n(1),r=n(0),i=n(14);t.exports=function(t,e,n,s,a,u){t.offlineController.getManifestInfo(a,function(t){if(t)n(r.getError(r.e.manifests.NOT_FOUND,a),t);else{new i(a,o.getSettings().stores.PERSISTENT,u).save().then(function(){e()},function(t){n(r.getError(r.e.downloads.SAVING_PERSISTENT_FAILED,a),t)})}})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,i,s){if(!t.manifestController.getManifestById(i))return void n(o.getError(o.e.manifests.NOT_FOUND,i));t.downloadsController.storage.getItem(i).then(function(r){r?n(o.getError(o.e.downloads.ALREADY_STARTED,i)):t.downloadsController.start(i,s,e,function(t){n(o.getError(o.e.downloads._GENERAL),t)})},function(t){n(o.getError(o.e.downloads._GENERAL),t)})}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.downloadsController.stop(r,e,n)}},function(t,e,n){"use strict";var o=n(0),r=n(6);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(i,s){if(i)n(o.getError(o.e.downloads.STOPPING_ALL_FAILED),i);else{for(var a=[],u=[],l=0,d=s.length;l<d;l++){var f=s[l].status,c=s[l].manifestInfo.id;f!==r.FINISHED&&(u.push(c),a.push(t.downloadsController.stopPromise(c,!0)))}u.length>0?Promise.all(a).then(function(){e(u)},function(t){n(o.getError(o.e.downloads.STOPPING_ALL_FAILED),t)}):n(o.getError(o.e.downloads.ALREADY_STOPPED_ALL))}})}},function(t,e,n){"use strict";function o(t,e,n,o,r,i){var a=void 0,u=void 0,l=void 0,d=r.sort().join(",");l=[],a=new s(function(){return t.downloadsController.downloadStats.getStats(r)},t.processSubscriber,o,d,i),l.push(t.subscribersController.addSubscriber(a)),u=new s(function(){for(var e=!0,n=0,o=r.length;n<o;n++)e=e&&t.downloadsController.isDownloadFinishedAndSynced(r[n]);return e},t.processSubscriber,o,d,i,!0),u.onFinish(function(e){a.remove();for(var n=[],o=0,i=r.length;o<i;o++)n.push(t.offlineController.getManifestInfoPromise(r[o]));Promise.all(n).then(function(t){e(null,t)},function(t){e(t)})}),l.push(t.subscribersController.addSubscriber(u)),e(null,l)}function r(t,e,n,o,r,a){var u=t.manifestController.getManifestById(r),l=void 0,d=void 0,f=void 0;u?(f=[],l=new s(function(){return t.downloadsController.downloadStats.getStats(r)},t.processSubscriber,o,r,a),f.push(t.subscribersController.addSubscriber(l)),d=new s(function(){return t.downloadsController.isDownloadFinishedAndSynced(r)},t.processSubscriber,o,r,a,!0),d.onFinish(function(e){l.remove(),t.offlineController.getManifestInfo(r,function(t,n){e(t,n)})}),f.push(t.subscribersController.addSubscriber(d)),e(u.getJsonInfo(),f)):n(i.getError(i.e.manifests.NOT_FOUND,r))}var i=n(0),s=n(68);t.exports=function(t,e,n,i,s,a){"string"==typeof s?r(t,e,n,i,s,a):o(t,e,n,i,s,a)}},function(t,e,n){"use strict";function o(t,e,n,o,s,a){this._process=t,this._callback=e,this._manifestId=o,this._id=String(r.SnowflakeId.getUUID()),this._onceOnly=a,this._target=n,this.onInterval=function(){var t=this._process(),e=this;t&&(this._onceOnly?(this.remove(),"function"==typeof this._callbackOnFinish?this._callbackOnFinish(function(t,n){e._callback(e._id,t,n,e._target,!0)}):this._callback(this._id,null,t,e._target)):this._callback(this._id,null,t,e._target))},i.bindAll(this,"onInterval"),this._intervalTimer=setInterval(this.onInterval,s)}var r=n(7),i=n(5);o.prototype.getId=function(){return this._id},o.prototype.getManifestId=function(){return this._manifestId},o.prototype.onFinish=function(t){this._callbackOnFinish=t},o.prototype.remove=function(){clearInterval(this._intervalTimer)},t.exports=o},function(t,e,n){"use strict";function o(t,e,n,o,i){t.manifestController.getManifestById(i)?(t.subscribersController.unsubscribe(i),e()):n(r.getError(r.e.manifests.NOT_FOUND,i))}var r=n(0);t.exports=function(t,e,n,r,i){"string"==typeof i?o(t,e,n,r,i):(t.subscribersController.unsubscribe(i),t.subscribersController.unsubscribe(i.sort().join(",")))}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.subscribersController.removeSubscribersById(r),e()}},function(t,e,n){"use strict";function o(t,e){this._manifestsDownloadOrder=[],this._manifestsDownloadOrderObj={},this._manifestController=t,this._offlineController=e,this.storage=new l,this._offlineController.setDownloadStorage(this.storage),this._names={downloadInProgress:"downloadInProgress",options:"options",maxDownloadInProgress:"maxDownloadInProgress"},this._STATS_TIME_GENERATION=1e3,this.downloadStats=new f(this.storage),r.bindAll(this,"_onDownloadEnd","_onDownloadError","isDownloadFinished")}var r=n(5),i=n(72),s=n(1),a=n(0),u=n(73),l=n(78),d=n(82),f=n(83),c=n(6),h=n(13),p=n(16),m=n(28);o.prototype._addDownloads=function(t,e,n,o){var r=!0;for(this._prepareStartOptions(t,e,n,o);r;)this._addNextItemToQueue(t,o),this._addNextItemToQueue(t,e),this._addNextItemToQueue(t,n),r=!!(o.length||e.length||n.length)},o.prototype._addNextItemToQueue=function(t,e){var n=void 0;e.length&&(n=e.shift(),n.manifestId=t,this.storage.left.push(t,n))},o.prototype._downloadOrderAddManifest=function(t,e){return!this._downloadOrderManifestExists(t)&&(this._manifestsDownloadOrderObj[t]=!0,e?this._manifestsDownloadOrder.unshift(t):this._manifestsDownloadOrder.push(t),!0)},o.prototype._downloadOrderGetManifestId=function(t){return this._manifestsDownloadOrder[t]},o.prototype._downloadOrderManifestExists=function(t){return this._manifestsDownloadOrderObj[t]},o.prototype._downloadOrderRemoveManifest=function(t){var e=!1,n=void 0,o=void 0;for(delete this._manifestsDownloadOrderObj[t],n=0,o=this._manifestsDownloadOrder.length;n<o;n++)if(this._manifestsDownloadOrder[n]===t){this._manifestsDownloadOrder.splice(n,1),e=!0;break}return e},o.prototype._finish=function(t,e,n){this.downloadStats.refresh(),this._downloadOrderRemoveManifest(t),this._manifestsDownloadOrder.length||this.downloadStats.stop(),this.storage.removeItem(t).then(e,n)},o.prototype._getDownloadHash=function(t){return t.remoteUrl+"-"+t.localUrl},o.prototype._markDownloadItem=function(t){var e=this,n=t.manifestId,o=e._getDownloadHash(t),r=[],i=void 0;t.events.removeListener("end",e._onDownloadEnd),t.events.removeListener("error",e._onDownloadError),1===e.storage.downloading.count(n)&&0===e.storage.left.count(n)&&(this.downloadStats.refresh(),i=!0),t.status===c.FINISHED?(e.storage.downloaded.push(n,t),r.push(this.storage.stores.DOWNLOADS.DOWNLOADED)):e.storage.errors.push(n,t),e.storage.downloading.removeItem(n,o),e.isDownloadFinished(n)&&(0===e.storage.errors.count(n)?e.storage.status.setItem(n,"status",c.FINISHED):e.storage.status.setItem(n,"status",c.ERROR),r.push(this.storage.stores.STATUS)),e.storage.sync(n,r).then(function(){e.storage.params.decrease(n,e._names.downloadInProgress),i?e._finish(n,function(){e.startQueue(),console.info("FINISHED",n)},function(){e.startQueue()}):e.startQueue()},function(t){console.error("ERROR",t)})},o.prototype._onDownloadError=function(t,e){console.error("ERROR",t.remoteUrl,e),this._markDownloadItem(t)},o.prototype._onDownloadEnd=function(t){this._markDownloadItem(t)},o.prototype._prepareStartOptions=function(t,e,n,o){var r=e.length+n.length+o.length;console.info("ADDING ->>> ",t+",",r,"fragments");var i={};this.storage.params.setItem(t,this._names.downloadInProgress,0);for(var a=void 0,u=s.getSettings().downloadingThreadsRules,l=0,d=u.items.length;l<d;l++)if(r<=u.items[l].max){i[u.threadName]=u.items[l].threads,a=u.items[l].files;break}this.storage.params.setItem(t,this._names.options,i),this.storage.params.setItem(t,this._names.maxDownloadInProgress,a),this._downloadOrderAddManifest(t)},o.prototype.isDownloadFinished=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)},o.prototype.isDownloadFinishedAndSynced=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)&&!this.storage.keyExists(t)},o.prototype.start=function(t,e,n,o,u){function l(t,e){var n=void 0,o=t.getElementsByTagName("MPD")[0];if(o)for(var r=0,i=o.childNodes.length;r<i;r++)if("BaseURL"===o.childNodes[r].nodeName){n=o.childNodes[r].textContent,n.match(p.regexpProtocolRemove)||(n=m.joinPath(e,n));break}return n||(n=e),n}var f=this;this.downloadStats.start();var h=this._manifestController.getManifestById(t);e=e||{};var g=e.video||[],v=e.audio||[],_=e.text||[],E=h.getVideoRepresentations(),I=h.getAudioRepresentations(),w=h.getTextRepresentations(),y=s.getSettings().downloadsFolderPath+t+"/",R=h.getManifestUrl(),S=h.getManifestName();Promise.all([this._offlineController.getManifestInfoPromise(t,!0),this.storage.getItem(t),i(y)]).then(function(e){var i=e[0];if(e[1]&&!f.isDownloadFinished(t))return void o(u?a.getError(a.e.downloads.ALREADY_RESUMED,t):a.getError(a.e.downloads.ALREADY_STARTED,t));i.manifest.video&&(g=r.union(g,i.manifest.video)),i.manifest.audio&&(v=r.union(v,i.manifest.audio)),i.manifest.text&&(_=r.union(_,i.manifest.text));for(var s=i.downloaded||[],p={},m=0,N=s.length;m<N;m++)p[s[m].localUrl]=s[m];var b=l(h.manifestXML.xml,h.url_domain),T=d.getDownloadLinks(t,y,b,g,E,p),O=d.getDownloadLinks(t,y,b,v,I,p),D=d.getDownloadLinks(t,y,b,_,w,p);f.storage.createIfNotExists(t).then(function(){f.storage.manifest.setItem(t,"ts",(new Date).getTime()),f.storage.manifest.setItem(t,"url",R),f.storage.manifest.setItem(t,"name",S),f.storage.manifest.setItem(t,"video",g),f.storage.manifest.setItem(t,"audio",v),f.storage.manifest.setItem(t,"text",_),f.storage.downloaded.clear(t),f.storage.downloaded.concat(t,s),f.storage.errors.clear(t),f.storage.status.setItem(t,"status",c.CREATED),Promise.all([f.storage.sync(t,[f.storage.stores.MANIFEST,f.storage.stores.STATUS]),f._manifestController.saveOriginalManifestOnceOnly(t),f._manifestController.saveManifestWithChosenRepresentations(t,{video:g,audio:v,text:_})]).then(function(){f._addDownloads(t,T,O,D),f.storage.status.setItem(t,"status",c.STARTED),f.storage.status.setItem(t,"left",f.storage.left.count(t)),f.storage.sync(t,[f.storage.stores.DOWNLOADS.DOWNLOADED,f.storage.stores.STATUS]).then(function(){f.downloadStats.refresh(),f.isDownloadFinished(t)?(f.storage.status.setItem(t,"status",c.FINISHED),f.storage.sync(t,f.storage.stores.STATUS).then(function(){f._finish(t,n,o)},o)):(f.downloadStats.start(),f.startQueue(),n())},o)},o)},o)})},o.prototype.stop=function(t,e,n){var o=this;o._downloadOrderRemoveManifest(t),o.storage.getItem(t).then(function(r){if(!r)return void n(a.getError(a.e.downloads.ALREADY_STOPPED,t));var i=o.storage.downloading.getKeys(t),s=void 0;console.info("STOPPING",t,i.length);for(var u=[],l=0,d=i.length;l<d;l++)s=o.storage.downloading.getItem(t,i[l]),s.events.removeListener("end",o._onDownloadEnd),s.events.removeListener("error",o._onDownloadError),u.push(s.stopPromise());o.storage.status.setItem(t,"status",c.STOPPED),u.push(o.storage.sync(t,[o.storage.stores.DOWNLOADS.DOWNLOADED,o.storage.stores.STATUS])),Promise.all(u).then(function(){o._finish(t,e,n)},function(e){n(a.getError(a.e.downloads.STOPPING_FAILED,t),e)})},function(e){n(a.getError(a.e.downloads.STOPPING_FAILED,t),e)})},o.prototype.stopPromise=function(t,e){var n=this;return new Promise(function(o,r){n.stop(t,o,function(t){if(t){if(e&&t.code===h.ERRORS.STOPPED)return void o();r(t)}else o()})})},o.prototype.removePromise=function(t){var e=this;return new Promise(function(n,o){e.stopPromise(t).then(function(){e.storage.removeItem(t).then(n,o)},function(r){r&&r.code===h.ERRORS.STOPPED?e.storage.removeItem(t).then(n,o):o(r)})})},o.prototype._addLinkToDownload=function(t,e){var n=this,o=Object.assign({},e),r=new u(o,n.storage.params.getItem(t,n._names.options)),i=n._getDownloadHash(e);n.storage.downloading.setItem(t,i,r),n.storage.status.setItem(t,"left",n.storage.left.count(t)+n.storage.errors.count(t)),n.storage.sync(t,n.storage.stores.STATUS),r.events.on("end",n._onDownloadEnd),r.events.on("error",n._onDownloadError),r.start()},o.prototype.startQueue=function(t){var e=void 0,n=void 0,o=void 0,r=void 0,i=void 0;if(void 0===t&&(t=0),!(t>=s.getSettings().numberOfManifestsInParallel)){if(!(r=this._downloadOrderGetManifestId(t))){e=0;var a=void 0,u=void 0,l=void 0;for(l=this.storage.getKeys(),a=0,u=l.length;a<u;a++)e+=this.storage.params.count(l[a],this._names.downloadInProgress);return void(0===e&&this.downloadStats.stop())}n=this.storage.params.getItem(r,this._names.downloadInProgress),i=this.storage.params.getItem(r,this._names.maxDownloadInProgress),n<i-1?(o=this.storage.left.shift(r),o?(this.storage.params.increase(r,this._names.downloadInProgress),this._addLinkToDownload(r,o)):t++,this.startQueue(t)):s.getSettings().numberOfManifestsInParallel>1&&t<s.getSettings().numberOfManifestsInParallel&&(t++,this.startQueue(t))}},t.exports=o},function(t,e,n){"use strict";var o=n(9);t.exports=function(t){return new Promise(function(e,n){o(t,function(t){t?n(t):e()})})}},function(t,e,n){"use strict";function o(t,e){this._defaults={},this._defaults.threads=u.getSettings().downloadingThreadsRules.threads,this.status=d.CREATED,Object.assign(this,t),this._options=Object.assign(this._defaults,e),this._options.maxDownloadRetry=u.getSettings().MAX_ERRORS_DOWNLOAD_RETRY,this._options.maxDownloadChunkRetry=u.getSettings().MAX_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.maxDownloadChunkInternetRetry=u.getSettings().MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.timeout=u.getSettings().times.DOWNLOAD_TIMEOUT,this._options.retryTimeout=u.getSettings().times.RETRY_TIMEOUT,this.stats={available:0,downloaded:0,file_size:0,writeProgress:0},r.bindAll(this,"_onError","_onEnd","_onData","_updateStats","_attachEvents","_removeEvents","_removeEventsOnStop"),this.events=new l}var r=n(5),i=n(74),s=n(75),a=n(9),u=n(1),l=n(15).EventEmitter,d=n(6);o.prototype._attachEvents=function(){this._dl.on("error",this._onError),this._dl.on("end",this._onEnd),this._dl.on("data",this._onData)},o.prototype._createLocalPath=function(t){var e=this.localUrl.split("/");e=e.slice(0,e.length-1),e=e.join("/"),a(e,t)},o.prototype._onData=function(){this._updateStats()},o.prototype._onEnd=function(){this.status=d.FINISHED,this._updateStats(),this._removeEvents(),this.events.emit("end",this)},o.prototype._onError=function(t){var e=this;this.status=d.ERROR,t=t||{};var n=t.message||"";e._removeEvents(),e._updateStats(),e.events.emit("error",e,n)},o.prototype._removeEvents=function(){"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd),this._dl.removeListener("data",this._onData))},o.prototype._removeEventsOnStop=function(){this._dl&&"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd))},o.prototype._updateStats=function(){this.status===d.FINISHED?(this.stats.available=this._dl.file_size,this.stats.writeProgress=1):(this.stats.available=this._dl.available,this.stats.writeProgress=this._dl.writeProgress),this.stats.downloaded=this._dl.downloaded,this.stats.file_size=this._dl.file_size},o.prototype.start=function(){var t=this;this.status=d.STARTED,this._createLocalPath(function(e){if(e)return void t._onError(e);var n=i.create();n.on("error",function(e){var o="";e&&(o=e.code),n.dispose(),t._onError({message:o})}),n.run(function(){t._dl=new s(t.remoteUrl,t.localUrl,t._options),t._attachEvents(),t._dl.start()})})},o.prototype.stop=function(t){var e=this;if(this.status=d.STOPPED,this._removeEventsOnStop(),"function"!=typeof t&&(t=function(){}),this._dl){var n=i.create();n.on("error",function(){t()}),n.run(function(){e._dl.on("error",function(){t()}),e._dl.on("end",function(){t()}),e._dl.stop()})}else t()},o.prototype.stopPromise=function(){var t=this;return new Promise(function(e){t.stop(function(){e()})})},t.exports=o},function(t,e){t.exports=require("domain")},function(t,e,n){"use strict";function o(t,e,n){this._url=t,this._destFile=e,this._options=n,this._resetValues()}var r=n(2),i=n(11),s=n(15).EventEmitter,a=n(76),u=n(24),l=n(77);a.inherits(o,s),o.prototype._calculateChunksNumber=function(t){for(var e=0,n=this._options.threads.length;e<n;e++)if(t<1048576*this._options.threads[e].size)return this._options.threads[e].number;return 1},o.prototype._concatChunks=function(){function t(){i.writeProgress=i._chunks.reduce(function(t,e){return t+e.writeProgress},0)/i._chunksNumber,i.emit("data")}function e(){return r.createWriteStream(i._chunks[0].destFile,{flags:"a"})}function n(e,n){i._chunks[n].writeProgress=e.bytesWritten/i._chunks[n].available,i._chunks[n].writeProgress>1&&(i._chunks[n].writeProgress=1),t()}function o(a,u){var l=i._chunks[u];if(l){var d=setInterval(function(){n(a,u)},s),f=r.createReadStream(l.destFile);f.pipe(a),a.on("close",function(){clearInterval(d),n(a,u),a.removeAllListeners(),f.unpipe(a),f.destroy(),r.unlink(l.destFile,function(t){t?i.emit("error",t):(a.destroy(),o(e(),u+1))})})}else t(),a.removeAllListeners(),a.destroy(),r.rename(i._chunks[0].destFile,i._destFile,function(t){t?i.emit("error",t):i.emit("end")})}var i=this,s=500;i._chunks[0].writeProgress=1,i._chunks.length>1?o(e(),1):(t(),i.emit("end"))},o.prototype._initChunk=function(t){var e={};e.bytesRangeNotAvailable=this._bytesRangeNotAvailable,e.destFile=this._destFile,e.maxDownloadRetry=this._options.maxDownloadChunkRetry,e.maxDownloadInternetRetry=this._options.maxDownloadChunkInternetRetry,e.timeout=this._options.timeout,e.retryTimeout=this._options.retryTimeout;var n=this.file_size;if(this._chunksNumber>1){var o=parseInt(n/this._chunksNumber,10);e.startPosition=t*o,e.multiChunks=!0,t===this._chunksNumber-1?e.endPosition=n-1:e.endPosition=e.startPosition+o-1}else e.startPosition=0,e.endPosition=n-1;var r=new l(this._url,e);r.events.on("download",this._onChunkDownload.bind(this)),this._chunks.push(r)},o.prototype._onDownloadFailure=function(t,e){this._promises=null,e?this.emit("error",t):(this._errors=this._errors||0,this._errors++,this._errors<=this._options.maxDownloadRetry?this._retryDownload():this.emit("error",t))},o.prototype._onDownloadSuccess=function(t){var e=void 0,n=void 0;this._promises=null,t=t||[];for(var o=0,r=t.length;o<r;o++)t[o]&&(t[o]===u.errors.ABORTED&&(e=!0),n=!0);n?this._onDownloadFailure(t,e):this._concatChunks()},o.prototype._onChunkDownload=function(t){this.downloaded+=t,this.available=this._chunks.reduce(function(t,e){return t+e.available},0),this.emit("data")},o.prototype._retryDownload=function(){this._resetValues(),this.start()},o.prototype._resetValues=function(){this.available=0,this.downloaded=0,this.progress=0,this.file_size=0,this.writeProgress=0,this._chunks=[]},o.prototype._startChunks=function(){for(var t=[],e=0,n=this._chunks.length;e<n;e++)t.push(this._chunks[e].start());this._promises=t,Promise.all(this._promises).then(this._onDownloadSuccess.bind(this),this._onDownloadFailure.bind(this))},o.prototype.start=function(){var t=this;i.head(this._url,u.defaultOptions,function(e,n){function o(){for(var e=0,n=t._chunksNumber;e<n;e++)t._initChunk(e);t._startChunks()}if(n&&n.statusCode>=400&&(e=n.statusMessage),e)return void t._onDownloadFailure(e,!1);t._headers=n.headers,t.file_size=Number(t._headers["content-length"]),t._chunksNumber=t._calculateChunksNumber(t.file_size),u.checkForLocalFile(t._destFile,function(e,n){e?n===t.file_size?t.emit("end"):n>t.file_size?(r.unlink(t._destFile),o()):n<t.file_size&&t._chunksNumber>1?(r.unlink(t._destFile),o()):o():o()})})},o.prototype.stop=function(){function t(){this.emit("end","")}for(var e=[],n=0,o=this._chunks.length;n<o;n++)this._chunks[n].stop(),this._chunks[n]._promise&&e.push(this._chunks[n]._promise);this._promises||Promise.all(e).then(t.bind(this),t.bind(this))},t.exports=o},function(t,e){t.exports=require("util")},function(t,e,n){"use strict";function o(t,e){var n=this;return this.url=t,this.options=e,this.endPosition=e.endPosition,this.startPosition=e.startPosition,this.bytesRangeNotAvailable=e.bytesRangeNotAvailable,this.reset(),this.events=new a,this._promise=new Promise(function(t,e){n.resolve=t,n.reject=e}),this}var r=n(24),i=n(2),s=n(11),a=n(15).EventEmitter;o.prototype._retry=function(t,e){var n=this,o=void 0;this._errors=this._errors||{},this._errors[t]=this._errors[t]||0,this._errors[t]++,o=t===r.errors.INTERNET?this.options.maxDownloadInternetRetry:this.options.maxDownloadRetry,this._errors[t]<=o?(n._timer&&clearTimeout(n._timer),e(!0),n._timer=setTimeout(function(){n.reset(function(){n.start()})},n.options.retryTimeout)):e(!1)},o.prototype.createFileStream=function(t){var e=this;if(this.fileStream)t();else{var n=this.options.destFile;this.options.multiChunks&&(n=n+"."+this.startPosition+"."+this.endPosition),r.checkForLocalFile(n,function(o,s){e.destFile=n,o&&s<=e.endPosition-e.startPosition&&(e.resumeFile=o,e.available=s,e.offsetStartPosition=s),e.fileStream=i.createWriteStream(n,{flags:e.resumeFile?"a":"w"}),e.fileStream.on("error",t),e.fileStream.on("open",function(){e.fileStream=this,this.removeListener("error",t),this.on("error",function(t){e._retry(r.errors.FILE_WRITING_ERROR,function(n){n||e.resolve(r.errors.FILE_WRITING_ERROR,t)})}),this.on("finish",function(){e.isDownloaded()?e.closeStreamAndRequest(e.resolve):e._retry(r.errors.CHUNK_SIZE_ERROR,function(t){t||e.closeStreamAndRequest(function(){e.resolve(r.errors.CHUNK_SIZE_ERROR)})})}),t()})})}},o.prototype.isDownloaded=function(){return this.endPosition-this.startPosition-this.offsetStartPosition+1===this.downloaded},o.prototype.start=function(){var t=this,e={timeout:this.options.timeout};return t.createFileStream(function(n){if(n)return void t._retry(r.errors.FILE_CREATING_ERROR,function(e){e||t.closeStreamAndRequest(function(){t.resolve(r.errors.FILE_CREATING_ERROR,n)})});e.headers=e.headers||{},t.bytesRangeNotAvailable||(e.headers.range="bytes="+(t.startPosition+t.offsetStartPosition)+"-"+t.endPosition),t._req=s(t.url,e),t._req.on("error",function(e){"ESOCKETTIMEDOUT"===e.code||"ENOTFOUND"===e.code||"ETIMEDOUT"===e.code?t._retry(r.errors.INTERNET,function(n){n||t.closeStreamAndRequest(function(){t.resolve(r.errors.TIMEOUT,e)})}):t.closeStreamAndRequest(function(){t.resolve(r.errors.CHUNK_ERROR)})}),t._req.on("data",function(e){t.available+=e.length,t.downloaded+=e.length,t.events.emit("download",e.length)}),t._req.pipe(t.fileStream)}),this._promise},o.prototype.closeStreamAndRequest=function(t){function e(){clearTimeout(o),n.fileStream&&(n.fileStream.destroy(),delete n.fileStream),delete n._req,t()}var n=this,o=void 0;this._req&&this._req.removeAllListeners(),this.fileStream&&this.fileStream.removeAllListeners(),this._req&&(this._req.abort(),this._req.timeoutTimer&&(clearTimeout(this._req.timeoutTimer),this._req.timeoutTimer=null)),this.fileStream?(o=setTimeout(function(){e()},300),this.fileStream.end(),this.fileStream.close(e)):(delete this._req,t())},o.prototype.reset=function(t){var e=this;t=t||function(){},e.closeStreamAndRequest(function(){e.offsetStartPosition=0,e.available=0,e.downloaded=0,e.writeProgress=0,e.resumeFile=!1,t()})},o.prototype.stop=function(){var t=this;this.reset(function(){t.resolve(r.errors.ABORTED)})},t.exports=o},function(t,e,n){"use strict";function o(){this.stores=i.getSettings().stores,this._items={},this._syncItems=[],this._FLUSH_TIME=50,this._flushThrottled=r.throttle(this._flush,this._FLUSH_TIME,{leading:!1}),this._createDummyStorageBridge()}var r=n(5),i=n(1),s=n(25),a=n(79),u=n(14),l=n(27),d=n(80),f=n(81);o.prototype._createArrayStorage=function(t,e){this[e]||this._createArrayStorageBridge(e),this._items[t][e]=new s},o.prototype._createArrayStorageBridge=function(t){this[t]=new a(this,t)},o.prototype._createDummyStorageBridge=function(){this._createArrayStorageBridge(this.stores.DOWNLOADS.LEFT),this._createArrayStorageBridge(this.stores.DOWNLOADS.DOWNLOADED),this._createStorageBridge(this.stores.DOWNLOADS.DOWNLOADING),this._createArrayStorageBridge(this.stores.DOWNLOADS.ERRORS),this._createStorageBridge(this.stores.PARAMS),this._createStorageBridge(this.stores.MANIFEST),this._createStorageBridge(this.stores.STATUS)},o.prototype._createStorage=function(t,e){this[e]||this._createStorageBridge(e),this._items[t][e]=new l},o.prototype._createStorageBridge=function(t){this[t]=new d(this,t)},o.prototype._flush=function(){var t=this,e=this._syncItems.splice(0,this._syncItems.length),n=void 0,o=void 0,r=void 0,i=void 0,s=void 0,a=void 0,l=void 0,d=void 0,f=void 0,c=void 0,h=void 0;for(h={},r=0,s=e.length;r<s;r++)for(i=e[r],h[i.manifestId]=h[i.manifestId]||{},a=0,l=i.storageKeys.length;a<l;a++)h[i.manifestId][i.storageKeys[a]]=!0;o=[];for(d in h){c=h[d];for(f in c)try{n=new u(d,f,function(e,n){return t._items[e]&&t._items[e][n]?t._items[e][n].getItems():[]}(d,f)),o.push(n.save())}catch(t){console.error("ERROR",f)}}Promise.all(o).then(function(){var t=void 0,n=void 0;for(t=0,n=e.length;t<n;t++)e[t].resolve()},function(){var t=void 0,n=void 0;for(t=0,n=e.length;t<n;t++)e[t].reject()})},o.prototype._getAllStorageKeys=function(t){var e=[];t=t||this.stores;for(var n in t)t.hasOwnProperty(n)&&("string"==typeof t[n]?n!==this.stores.PARAMS&&e.push(t[n]):e=e.concat(this._getAllStorageKeys(t[n])));return e},o.prototype._itemAction=function(t,e,n){var o=[],r=void 0,i=void 0;for(r=3,i=arguments.length;r<i;r++)o.push(arguments[r]);return this._items[n]&&this._items[n][t]&&this._items[n][t][e]?this._items[n][t][e].apply(this._items[n][t],o):void(this._items[n]&&console.error("ERROR",n,t,e,o))},o.prototype.clear=function(t,e){var n=this;return new Promise(function(o,r){if(e=e||n._getAllStorageKeys(),n._items[t])for(var i=0,s=e.length;i<s;i++){var a=n._items[t][e[i]];a&&a.clear()}delete n._items[t],n.sync(t,e).then(o,r)})},o.prototype.create=function(t){var e=this;return new Promise(function(n,o){e._items[t]={},e._createArrayStorage(t,e.stores.DOWNLOADS.LEFT),e._createArrayStorage(t,e.stores.DOWNLOADS.DOWNLOADED),e._createStorage(t,e.stores.DOWNLOADS.DOWNLOADING),e._createArrayStorage(t,e.stores.DOWNLOADS.ERRORS),e._createStorage(t,e.stores.PARAMS),e._createStorage(t,e.stores.MANIFEST),e._createStorage(t,e.stores.STATUS),e.sync(t,[e.stores.DOWNLOADS.DOWNLOADED,e.stores.MANIFEST,e.stores.STATUS]).then(n,o)})},o.prototype.createIfNotExists=function(t){var e=this;return new Promise(function(n,o){e.getItem(t).then(function(r){r?n():e.create(t).then(n,o)},o)})},o.prototype.getItem=function(t){var e=this;return new Promise(function(n){n(e._items[t])})},o.prototype.getKeys=function(){return Object.keys(this._items)},o.prototype.keyExists=function(t){return!!this._items[t]},o.prototype.removeItem=function(t){var e=this;return new Promise(function(n){delete e._items[t],n()})},o.prototype.sync=function(t,e){var n=this;return new Promise(function(o,r){if(void 0===e)return void r("Storage key is missing");"string"==typeof e&&(e=[e]),i.getSettings().saveToDisk?(n._syncItems.push(new f(o,r,t,e)),n._flushThrottled()):o()})},o.prototype.syncAll=function(t){var e=this;return new Promise(function(n,o){if(i.getSettings().saveToDisk){var r=e._getAllStorageKeys();e._syncItems.push(new f(n,o,t,r)),e._flushThrottled()}else n()})},t.exports=o},function(t,e,n){"use strict";function o(t,e){this._parent=t,this._storageKey=e,i(this,r)}var r=n(25),i=n(26);t.exports=o},function(t,e,n){"use strict";function o(t,e){this._parent=t,this._storageKey=e,i(this,r)}var r=n(27),i=n(26);t.exports=o},function(t,e,n){"use strict";function o(t,e,n,o){this.resolve=t,this.reject=e,this.manifestId=n,this.storageKeys=o}t.exports=o},function(t,e,n){"use strict";var o=n(16),r=n(28),i={};i.getDownloadLinks=function(t,e,n,s,a,u){var l=i.getChosenRepresentations(s,a),d=void 0,f=void 0,c=void 0,h=void 0,p=void 0,m=void 0,g=void 0,v=void 0,_=void 0,E=void 0,I=void 0,w=void 0,y=void 0,R=void 0;for(_=[],u=u||{},h=0,m=l.length;h<m;h++)for(f=l[h].attributeList.mimeType,d=+l[h].attributeList.bandwidth,f=0===f.indexOf("video")?"video":0===f.indexOf("audio")?"audio":"text",R=l[h].segmentInformation,w=R.mediaUrls,p=R.representationID,g=0,v=w.length;g<v;g++)E=w[g].mediaFile,I=w[g].baseURL,I=I.replace(/\.\.\//g,""),I=I.replace(/\.\./g,""),E!==I&&n!==I||(I=""),I.match(o.regexpProtocolRemove)?(y=r.joinPathWithFile(I,E),c=r.joinPathWithFile(e,I.replace(o.regexpProtocolRemove,""),E)):(y=r.joinPathWithFile(n,I,E),c=r.joinPathWithFile(e,I,E)),u[c]&&(u[c]||u[c].remoteUrl===y)||_.push({id:p,bandwidth:d,contentType:f,remoteUrl:y,localUrl:c});return _},i.getChosenRepresentations=function(t,e){var n=[],o={};t=t||[],e=e||[];for(var r=0,i=t.length;r<i;r++)o[String(t[r])]=!0;for(var s=0,a=e.length;s<a;s++)for(var u=e[s].representationColl,l=0,d=u.length;l<d;l++){var f=u[l];o[String(f.attributeList.id)]&&n.push(f)}return n},t.exports=i},function(t,e,n){"use strict";function o(t){this._storage=t,this._stats={},this._statsPrevious={},this._STATS_TIME_GENERATION=1e3,r.bindAll(this,"_generate")}var r=n(5);o.prototype._convertToBytes=function(t,e,n,o){return n=void 0!==n?n:e,o=void 0!==o?o:e,t<1e5?this._convertToKB(t,e):t<1073741824?this._convertToMB(t,n):this._convertToGB(t,o)},o.prototype._convertToKB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1024)/n+"kB"},o.prototype._convertToMB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1048576)/n+"MB"},o.prototype._convertToGB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1073741824)/n+"GB"},o.prototype._clearSpeed=function(){for(var t=Object.keys(this._stats)||[],e=0,n=t.length;e<n;e++){var o=t[e];!this._storage.keyExists(o)&&this._stats[o]&&this._stats[o].speed&&(this._stats[o].speed=0,this._stats[o].speedBytes=this._convertToBytes(this._stats[o].speed,3,2))}},o.prototype._generate=function(t){function e(t){for(var e=0,n=0,o=t.length;n<o;n++){e+=t[n].bandwidth||1}return e}function n(t,e){var n=0;for(var o in t)if(t.hasOwnProperty(o)){var r=t[o];n+=(e?r.stats.available/(r.stats.file_size||1):1)*(r.bandwidth||1)}return n}var o={},i=this._storage.getKeys();this._clearSpeed();var s={downloading:0,downloaded:0,available:0,left:0,downloadingAvailableBytes:0,downloading_file_size:0,downloadingBytes:0,downloadedBytes:0,availableBytes:0,writeProgress:0,writeProgressDownloading:0,writeProgressDownloaded:0,errors:0,progress:0,speed:0},a=(new Date).getTime();this._statsTime||(this._statsTime=a);for(var u=0,l=i.length;u<l;u++){var d=i[u];o[d]=r.clone(s),o[d].left=this._storage.left.count(d),o[d].leftI=this._storage.left.getItems(d),o[d].errors=this._storage.errors.count(d),o[d].errorsI=this._storage.errors.getItems(d);var f=this._storage.downloading.getKeys(d);o[d].downloading=f.length,o[d].downloadingI=this._storage.downloading.getItems(d);for(var c=f.length,h=0,p=f.length;h<p;h++){var m=this._storage.downloading.getItem(d,f[h]);o[d].downloadingBytes+=m.stats.downloaded,o[d].downloading_file_size+=m.stats.file_size,o[d].downloadingAvailableBytes+=m.stats.available,o[d].writeProgressDownloading+=m.stats.writeProgress}f=this._storage.downloaded.getItems(d),o[d].downloaded=f.length,o[d].downloadedI=f;for(var g=f.length,v=0,_=f.length;v<_;v++){var E=f[v];o[d].downloadedBytes+=E.stats.downloaded,o[d].writeProgressDownloaded+=E.stats.writeProgress}o[d].writeProgressDownloading=o[d].writeProgressDownloading*(o[d].downloadingAvailableBytes/(o[d].downloadedBytes+o[d].downloading_file_size)||1),o[d].writeProgressDownloading=o[d].writeProgressDownloading/(c||1),o[d].writeProgressDownloaded=o[d].writeProgressDownloaded*(o[d].downloadedBytes/(o[d].downloadedBytes+o[d].downloading_file_size)||1),o[d].writeProgressDownloaded=o[d].writeProgressDownloaded/(g||1),o[d].writeProgress=o[d].writeProgressDownloading+o[d].writeProgressDownloaded;var I=this._getDiff("downloadingBytes",d,o,this._statsPrevious);I+=this._getDiff("downloadedBytes",d,o,this._statsPrevious),I=1e3*I/(a-this._statsTime||1),o[d].speed=I;var w=e(o[d].leftI),y=e(o[d].downloadedI),R=n(o[d].downloadingI),S=n(o[d].downloadingI,!0),N=n(o[d].errorsI),b=w+y+R+N;o[d].progress=(y+S)/(b||1),o[d].progress=.9*o[d].progress,o[d].progress+=.1*o[d].writeProgress,o[d].downloadedBytesTotal=Math.round(1e4*o[d].progress)/100,o[d].downloadedBytesTotal+="%"}for(var T={},O=0,D=i.length;O<D;O++){var A=i[O];T[A]={};var L=o[A].downloadedBytes+o[A].downloadingAvailableBytes;T[A].progress=o[A].progress,T[A].progressPercentage=o[A].downloadedBytesTotal,T[A].downloadedBytesTotal=this._convertToBytes(L,1,2,2),T[A].downloaded=o[A].downloaded,T[A].left=o[A].left,T[A].errors=o[A].errors,o[A].speed<0&&(o[A].speed=0),T[A].speed=o[A].speed,T[A].speedBytes=this._convertToBytes(o[A].speed,3,2)}for(var P in T)T.hasOwnProperty(P)&&(this._stats[P]=T[P]);if(!t){this._statsTime=a;for(var M in o)o.hasOwnProperty(M)&&(this._statsPrevious[M]=o[M])}},o.prototype._getDiff=function(t,e,n,o){return(n[e]&&n[e][t]||0)-(o[e]&&o[e][t]||0)},o.prototype.getStats=function(t){var e=void 0;if(this._stats)if("string"==typeof t)e=this._stats[t];else{e=[];for(var n=0,o=t.length;n<o;n++){var r=this._stats[t[n]];r&&e.push(r)}}return e},o.prototype.refresh=function(){this._generate(!0)},o.prototype.start=function(){this._interval||(this._interval=setInterval(this._generate,this._STATS_TIME_GENERATION),this._generate())},o.prototype.stop=function(){clearInterval(this._interval),this._interval=null,this._generate()},t.exports=o},function(t,e,n){"use strict";var o=n(85);t.exports=function(t,e){var n=o.createServer().once("error",function(t){if(t)return e(t);e(null,!0)}).once("listening",function(){n.once("close",function(){e(null,!1)}).close()}).listen(t)}},function(t,e){t.exports=require("net")},function(t,e,n){"use strict";function o(){this._manifests={}}var r=n(2),i=n(3),s=n(12).XMLSerializer,a=n(1),u=n(87),l=n(88),d=n(0);o.prototype.cacheManifest=function(t){this._manifests[t.id]=t},o.prototype.getManifests=function(t){var e=void 0;if(void 0===t)e=this._manifests;else if("number"==typeof t||"string"==typeof t)e=[this._manifests[String(t)]];else{e=[];for(var n=0,o=t.length;n<o;n++)this._manifests[t[n]]&&e.push(this._manifests[t[n]])}return e},o.prototype.getManifestById=function(t){if("number"==typeof t||"string"==typeof t)return this._manifests[String(t)]},o.prototype.getManifestsInfo=function(t){for(var e=[],n=this.getManifests(t),o=0,r=n.length;o<r;o++)e.push(n[o].getJsonInfo());return e},o.prototype.getOriginalManifestLocalPath=function(t){return a.getSettings().settingsFolder+t+"/"},o.prototype.getManifestInfoById=function(t){var e=this.getManifestById(t);if(e)return e.getJsonInfo()},o.prototype.removeFromCache=function(t){"number"!=typeof t&&"string"!=typeof t||(t=[String(t)]),t=t||[];for(var e=0,n=t.length;e<n;e++)delete this._manifests[t[e]]},o.prototype.removeFromCacheAll=function(){this._manifests=[]},o.prototype.saveOriginalManifestOnceOnly=function(t){var e=this.getOriginalManifestLocalPath(t),n=this;return new Promise(function(o,a){var u=n.getManifestById(t);if(!u)return void a(d.getError(d.e.manifests.NOT_FOUND,t));r.exists(i.resolve(e+u.getManifestName()),function(t){if(t)o();else{var n=new s,r=void 0;try{r=n.serializeToString(u.getManifestXML())}catch(t){return void a(t)}l(e,u.getManifestName(),r,function(t){t?a(t):o()})}})})},o.prototype.saveManifestWithChosenRepresentations=function(t,e){var n=a.getSettings().downloadsFolderPath+t+"/",o=this;return new Promise(function(r,i){var s=o.getManifestById(t);if(!s)return void i(d.getError(d.e.manifests.NOT_FOUND,t));var a=void 0;try{a=u(s,e)}catch(t){return void i(t)}l(n,s.getManifestName(),a,function(t){t?i(t):r()})})},t.exports=o},function(t,e,n){"use strict";function o(t){return-1!==t.indexOf("video")?"video":-1!==t.indexOf("audio")?"audio":"text"}function r(t,e){function n(t){for(var e=0,n=t.length;e<n;e++)for(var r=0,i=t[e].representationColl.length;r<i;r++){var s=t[e].representationColl[r].attributeList.id,a=o(t[e].representationColl[r].attributeList.mimeType);g[a][s]&&t[e].representationColl[r].markNodeForDownload(!0)}}function r(t){for(var e=0,n=t.length;e<n;e++){var o=t[e].currentNode.getElementsByTagName("BaseURL")[0];o&&o.textContent.match(i.regexpProtocolRemove)&&(o.textContent=o.textContent.replace(i.regexpProtocolRemove,""))}}var l=t.id,d=new u,f=t.getManifestUrl(),c=d.serializeToString(t.getManifestXML());t=new s(l),t.loadFromStr(c,f);var h=e.video,p=e.audio,m=e.text,g={};g.video={};for(var v=0,_=h.length;v<_;v++)g.video[h[v]]=!0;g.audio={};for(var E=0,I=p.length;E<I;E++)g.audio[p[E]]=!0;g.text={};for(var w=0,y=m.length;w<y;w++)g.text[m[w]]=!0;n(t.getVideoRepresentations()),n(t.getAudioRepresentations()),n(t.getTextRepresentations()),r(t.getVideoRepresentations()),r(t.getAudioRepresentations()),r(t.getTextRepresentations());var R=a.removeNode(t.getManifestXML());return d.serializeToString(R)}var i=n(16),s=n(10).Manifest,a=n(17).ManifestXML,u=n(12).XMLSerializer;t.exports=r},function(t,e,n){"use strict";function o(t,e,n,o){r(t,function(r){if(r)o(r);else{var a=s.resolve(t+"/"+e);i.writeFile(a,n,"utf-8",o)}})}var r=n(9),i=n(2),s=n(3);t.exports=o},function(t,e,n){"use strict";function o(t){this._manifestController=t}var r=n(3),i=n(22),s=n(1),a=n(90),u=n(91),l=n(10).Manifest,d=n(6);o.prototype.getManifestsList=function(t){Promise.all([u(s.getSettings().settingsFolder,!0,!1),u(s.getSettings().downloadsFolderPath,!0,!1)]).then(function(e){for(var n=[],o=e[0],r=e[1],i={},s=0,a=r.length;s<a;s++)i[r[s]]=!0;for(var u=0,l=o.length;u<l;u++)n.push(o[u]);t(null,n)},function(e){t(e)})},o.prototype.getManifestsListWithInfo=function(t){var e=this;this.getManifestsList(function(n,o){if(n)t(n);else{for(var r=[],i=0,s=o.length;i<s;i++)r.push(e.getManifestInfoPromise(o[i]));Promise.all(r).then(function(e){for(var n=[],o=0,r=e.length;o<r;o++)e[o]&&n.push(e[o]);t(null,n)},function(e){t(e)})}})},o.prototype.getManifestInfo=function(t,e,n){function o(n){var o=n.manifest.name,a=n.manifest.url,u=r.resolve(s.getSettings().settingsFolder+"/"+t+"/"+o),d=i._manifestController.getManifestById(t);d?(n.manifestInfo=d.getJsonInfo(),e(null,n)):(d=new l(t),d.loadFromLocal(u,a).then(function(){i._manifestController.cacheManifest(d),n.manifestInfo=d.getJsonInfo(),e(null,n)},function(t){"ENOENT"===t.code?e():e(t)}))}var i=this;Promise.all([new a(t,s.getSettings().stores.MANIFEST),new a(t,s.getSettings().stores.DOWNLOADS.DOWNLOADED),new a(t,s.getSettings().stores.STATUS),new a(t,s.getSettings().stores.PERSISTENT),new a(t,s.getSettings().stores.DATA)]).then(function(e){var r={},s=e[0]||{},a=e[1]||[],u=e[2]||{},l=e[3]||"",f=e[4]||"";r.status=u.status||d.BROKEN,i.downloadStorage.keyExists(t)||r.status!==d.STARTED||(r.status=d.BROKEN),r.manifest=s,r.left=u.left||0,r.persistent=l,r.downloaded=n?a:a.length,r.data=f,o(r)},e)},o.prototype.getManifestInfoPromise=function(t,e){var n=this;return new Promise(function(o,r){n.getManifestInfo(t,function(t,e){t?r(t):o(e)},e)})},o.prototype.remove=function(t,e,n){var o=s.getSettings().settingsFolder+t,r=s.getSettings().downloadsFolderPath+t;i(r,function(t){t&&"ENOENT"!==t.code?n(t):i(o,function(t){t&&"ENOENT"!==t.code?n(t):e()})})},o.prototype.removePromise=function(t){var e=this;return new Promise(function(n,o){e.remove(t,n,o)})},o.prototype.removeAllPromise=function(){return new Promise(function(t,e){var n=s.getSettings().settingsFolder,o=s.getSettings().downloadsFolderPath;i(o,function(o){o&&"ENOENT"!==o.code?e(o):i(n,function(n){n&&"ENOENT"!==n.code?e(n):t()})})})},o.prototype.restoreLocalManifest=function(t,e,n){var o=this;this.getManifestInfo(t,function(r,i){var s={};s.video=i.manifest.video,s.audio=i.manifest.audio,s.text=i.manifest.text,o._manifestController.saveManifestWithChosenRepresentations(t,s).then(e,n)})},o.prototype.setDownloadStorage=function(t){this.downloadStorage=t},t.exports=o},function(t,e,n){"use strict";function o(t,e){if(!t)throw new Error("manifestId is missing");return this._manifestId=t,this._itemName=e,new Promise(this._read.bind(this))}var r=n(23),i=n(3),s=n(1);o.prototype._read=function(t){var e=i.resolve(s.getSettings().settingsFolder+"/"+this._manifestId+"/"+this._itemName+".json");r.readFile(e,function(e,n){e?t():t(n)})},t.exports=o},function(t,e,n){"use strict";function o(t,e,n,o){var r=s.resolve(t+"/"+e);return new Promise(function(t,s){i.stat(r,function(r,i){if(r)return void s(r);i.isDirectory()?(n||(e=void 0),t(e)):(o||(e=void 0),t(e))})})}function r(t,e,n){return void 0===e&&(e=!0),void 0===n&&(n=!0),new Promise(function(r,s){i.readdir(t,function(i,a){if(i)"ENOENT"===i.code||"ENOTDIR"===i.code?r([]):s(i.message);else{for(var u=[],l=0,d=a.length;l<d;l++)u.push(o(t,a[l],e,n));Promise.all(u).then(function(t){r(t.filter(function(t){return void 0!==t}))},function(t){s(t)})}})})}var i=n(2),s=n(3);t.exports=r},function(t,e,n){"use strict";function o(){this._subscribers={}}o.prototype.addSubscriber=function(t){var e=t.getId();return this._subscribers[e]=t,e},o.prototype.removeSubscribersById=function(t){"string"==typeof t&&(t=[t]);for(var e=0,n=t.length;e<n;e++)this._subscribers[t[e]]&&(this._subscribers[t[e]].remove(),delete this._subscribers[t[e]])},o.prototype.removeAllManifestSubscribersById=function(t){var e=t&&this._subscribers[t];e&&this.unsubscribe(e.getManifestId())},o.prototype.unsubscribe=function(t){var e=[],n={};"string"==typeof t&&(t=[t]),t=t||[];for(var o=0,r=t.length;o<r;o++)n[t[o]]=!0;for(var i in this._subscribers)this._subscribers.hasOwnProperty(i)&&n[this._subscribers[i].getManifestId()]&&e.push(i);this.removeSubscribersById(e)},o.prototype.unsubscribeAll=function(){for(var t in this._subscribers)this._subscribers.hasOwnProperty(t)&&this._subscribers[t].remove();this._subscribers={}},t.exports=o},function(t,e){t.exports=g}])});